<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Summoner Selector</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: radial-gradient(circle at center, #0c0c0c, #000);
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.selector-wrapper {
  border: 3px solid #00ffff;
  border-radius: 12px;
  background: rgba(10,10,10,0.9);
  box-shadow: 0 0 30px rgba(0,255,255,0.4);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 24px;
  width: 400px;
}
.selector-header {
  font-size: 22px;
  font-weight: bold;
  color: #00ffff;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 18px;
  text-shadow: 0 0 10px #00ffff;
}
.search-row {
  display: flex;
  gap: 10px;
  width: 100%;
  justify-content: center;
  margin-bottom: 10px;
}
.search-row input, .search-row select {
  background: #111;
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #fff;
  padding: 8px 12px;
  font-size: 14px;
}
.search-row select { width: 100px; cursor: pointer; }
.search-row button {
  background: #00ffff; color: #000;
  border: none; border-radius: 6px;
  padding: 8px 14px; font-weight: bold;
  cursor: pointer; transition: 0.2s;
}
.search-row button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 10px #00ffff;
}
.profile-display {
  width: 200px; height: 200px;
  border: 2px solid #00ffff;
  border-radius: 12px;
  background: #111;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; margin: 12px 0;
}
.profile-display img {
  width: 100%; height: 100%; object-fit: cover;
}
.summoner-name { font-size: 18px; margin-top: 10px; text-shadow: 0 0 8px #00ffff; }
.summoner-level { font-size: 13px; color: #aaa; margin-top: 4px; }
.rank-display { margin-top: 10px; font-size: 14px; color: #00ffff; text-shadow: 0 0 8px rgba(0,255,255,0.7); }
.note { font-size: 12px; color: #888; margin-top: 10px; text-align: center; }
.action-row { margin-top: 20px; display: flex; gap: 12px; }
.action-row button {
  padding: 10px 20px; border: none;
  border-radius: 8px; font-weight: bold;
  cursor: pointer; transition: 0.2s;
}
.save-btn { background: #00ffff; color: #000; }
.home-btn { background: #111; border: 1px solid #00ffff; color: #00ffff; }
.save-btn:hover, .home-btn:hover { transform: scale(1.05); }
</style>
</head>
<body>

<div class="selector-wrapper">
  <div class="selector-header">Summoner Finder</div>

  <div class="search-row">
    <select id="region-select">
      <option value="BR1">BR1</option><option value="EUN1">EUN1</option><option value="EUW1" selected>EUW1</option>
      <option value="JP1">JP1</option><option value="KR">KR</option><option value="LA1">LA1</option>
      <option value="LA2">LA2</option><option value="ME1">ME1</option><option value="NA1">NA1</option>
      <option value="OC1">OC1</option><option value="RU">RU</option><option value="SG2">SG2</option>
      <option value="TR1">TR1</option><option value="TW2">TW2</option><option value="VN2">VN2</option>
    </select>
    <input type="text" id="summoner-input" placeholder="Enter Summoner Name...">
    <button id="search-btn">Search</button>
  </div>

  <div class="profile-display">
    <img id="profile-icon" src="https://ddragon.leagueoflegends.com/cdn/13.20.1/img/profileicon/29.png" alt="Profile Icon">
  </div>

  <div class="summoner-name" id="summoner-name">No Profile Loaded</div>
  <div class="summoner-level" id="summoner-level"></div>
  <div class="rank-display" id="summoner-rank"></div>
  <div class="note" id="status-note">Search a summoner to view profile.</div>

  <div class="action-row">
    <button class="save-btn" id="save-profile">Save</button>
    <button class="home-btn" id="goto-home">Enter Home</button>
  </div>
</div>

<script>
let currentSummoner = null;
let apiOnline = false;

// 🔹 Step 1: Check Riot API Status before anything else
async function checkRiotStatus(region = "NA1") {
  const note = document.getElementById("status-note");
  note.textContent = "Checking Riot API status...";
  try {
    const res = await fetch(`/api/riot-api?endpoint=/lol/status/v4/platform-data&region=${region}`);
    if (!res.ok) throw new Error("Bad status response");
    const data = await res.json();

    if ((data.maintenances?.length || 0) > 0 || (data.incidents?.length || 0) > 0) {
      note.textContent = `⚠️ ${data.name} API may be under maintenance.`;
      apiOnline = true; // still allow usage
    } else {
      note.textContent = `✅ ${data.name} API Online.`;
      apiOnline = true;
    }
  } catch (err) {
    console.error("API status error:", err);
    note.textContent = "❌ Riot API unreachable — please try again later.";
    apiOnline = false;
  }
}

// 🔹 Step 2: Normalize + Fetch Summoner → Rank
async function fetchSummonerProfile(name, region = "NA1") {
  const note = document.getElementById("status-note");
  if (!apiOnline) {
    note.textContent = "⚠️ API offline or not verified yet.";
    return;
  }

  note.textContent = "Loading summoner data...";
  const cleanName = name.trim().replace(/#/g, "").replace(/\s+/g, " ");

  try {
    // 1️⃣ Summoner Info
    const res = await fetch(`/api/riot-api?endpoint=/lol/summoner/v4/summoners/by-name/${encodeURIComponent(cleanName)}&region=${region}`);
    if (!res.ok) throw new Error("Summoner not found");
    const summoner = await res.json();
    if (!summoner.puuid) throw new Error("No PUUID returned");

    // 2️⃣ Ranked Info
    const rankedRes = await fetch(`/api/riot-api?endpoint=/lol/league/v4/entries/by-summoner/${summoner.id}&region=${region}`);
    const ranked = rankedRes.ok ? await rankedRes.json() : [];
    const solo = ranked.find(r => r.queueType === "RANKED_SOLO_5x5");

    // 3️⃣ Display
    document.getElementById("profile-icon").src =
      `https://ddragon.leagueoflegends.com/cdn/14.1.1/img/profileicon/${summoner.profileIconId}.png`;
    document.getElementById("summoner-name").textContent = summoner.name;
    document.getElementById("summoner-level").textContent = `Level ${summoner.summonerLevel}`;
    document.getElementById("summoner-rank").textContent = solo
      ? `${solo.tier} ${solo.rank} · ${solo.leaguePoints} LP`
      : "Unranked";

    // 4️⃣ Cache
    currentSummoner = {
      name: summoner.name,
      id: summoner.id,
      puuid: summoner.puuid,
      level: summoner.summonerLevel,
      profileIconId: summoner.profileIconId,
      region,
      rank: solo || null
    };

    note.textContent = "✅ Profile loaded — save or enter home.";
  } catch (err) {
    console.error(err);
    note.textContent = "❌ Summoner not found or API error.";
  }
}

// 🔹 Step 3: Events
document.getElementById("search-btn").addEventListener("click", () => {
  const name = document.getElementById("summoner-input").value.trim();
  const region = document.getElementById("region-select").value;
  if (name) fetchSummonerProfile(name, region);
});

document.getElementById("save-profile").addEventListener("click", () => {
  if (currentSummoner) {
    localStorage.setItem("selectedSummoner", JSON.stringify(currentSummoner));
    document.getElementById("status-note").textContent = "💾 Profile saved locally!";
  } else {
    document.getElementById("status-note").textContent = "⚠️ No profile loaded.";
  }
});

document.getElementById("goto-home").addEventListener("click", () => {
  const saved = localStorage.getItem("selectedSummoner");
  if (!saved && !currentSummoner) {
    document.getElementById("status-note").textContent = "⚠️ Load a profile first.";
    return;
  }
  window.location.href = "homeroom.html";
});

// 🔹 Auto-run status check when page loads
window.addEventListener("load", () => {
  const region = document.getElementById("region-select")?.value || "NA1";
  checkRiotStatus(region);
});
</script>

</body>
</html>
