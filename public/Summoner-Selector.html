<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Summoner Selector</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: radial-gradient(circle at center, #0c0c0c, #000);
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.selector-wrapper {
  border: 3px solid #00ffff;
  border-radius: 12px;
  background: rgba(10,10,10,0.9);
  box-shadow: 0 0 30px rgba(0,255,255,0.4);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 24px;
  width: 400px;
}
.selector-header {
  font-size: 22px;
  font-weight: bold;
  color: #00ffff;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 18px;
  text-shadow: 0 0 10px #00ffff;
}
.search-row {
  display: flex;
  gap: 10px;
  width: 100%;
  justify-content: center;
  margin-bottom: 10px;
}
.search-row input, .search-row select {
  background: #111;
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #fff;
  padding: 8px 12px;
  font-size: 14px;
}
.search-row input { flex: 1; min-width: 0; }
.search-row select { width: 100px; cursor: pointer; flex-shrink: 0; }
.search-row button {
  background: #00ffff; color: #000;
  border: none; border-radius: 6px;
  padding: 8px 14px; font-weight: bold;
  cursor: pointer; transition: 0.2s;
}
.search-row button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 10px #00ffff;
}
.profile-display {
  width: 200px; height: 200px;
  border: 2px solid #00ffff;
  border-radius: 12px;
  background: #111;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; margin: 12px 0;
}
.profile-display img {
  width: 100%; height: 100%; object-fit: cover;
}
.summoner-name { font-size: 18px; margin-top: 10px; text-shadow: 0 0 8px #00ffff; }
.summoner-level { font-size: 13px; color: #aaa; margin-top: 4px; }
.rank-display { margin-top: 10px; font-size: 14px; color: #00ffff; text-shadow: 0 0 8px rgba(0,255,255,0.7); }
.note { font-size: 12px; color: #888; margin-top: 10px; text-align: center; }
.action-row { margin-top: 20px; display: flex; gap: 12px; }
.action-row button {
  padding: 10px 20px; border: none;
  border-radius: 8px; font-weight: bold;
  cursor: pointer; transition: 0.2s;
}
.action-row button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}
.save-btn { background: #00ffff; color: #000; }
.home-btn { background: #111; border: 1px solid #00ffff; color: #00ffff; }
.save-btn:hover:not(:disabled), .home-btn:hover:not(:disabled) { transform: scale(1.05); }
</style>
</head>
<body>

<div class="selector-wrapper">
  <div class="selector-header">Summoner Finder</div>

  <div class="search-row">
    <select id="region-select">
      <option value="BR1">BR1</option><option value="EUN1">EUN1</option><option value="EUW1" selected>EUW1</option>
      <option value="JP1">JP1</option><option value="KR">KR</option><option value="LA1">LA1</option>
      <option value="LA2">LA2</option><option value="ME1">ME1</option><option value="NA1">NA1</option>
      <option value="OC1">OC1</option><option value="RU">RU</option><option value="SG2">SG2</option>
      <option value="TR1">TR1</option><option value="TW2">TW2</option><option value="VN2">VN2</option>
    </select>
    <input type="text" id="summoner-input" placeholder="Enter Summoner Name...">
    <button id="search-btn">Search</button>
  </div>

  <div class="profile-display">
    <img id="profile-icon" src="https://ddragon.leagueoflegends.com/cdn/13.20.1/img/profileicon/29.png" alt="Profile Icon">
  </div>

  <div class="summoner-name" id="summoner-name">No Profile Loaded</div>
  <div class="summoner-level" id="summoner-level"></div>
  <div class="rank-display" id="summoner-rank"></div>
  <div class="note" id="status-note">Search a summoner to view profile.</div>
  <div class="note" id="server-status" style="margin-top: 5px; font-size: 11px; color: #0f0;"></div>

  <div class="action-row">
    <button class="save-btn" id="save-profile" disabled>Save</button>
    <button class="home-btn" id="goto-home">Enter Home</button>
  </div>
</div>

<script>
let currentSummoner = null;

async function checkServerStatus(region = "NA1") {
  const statusElement = document.getElementById("server-status");
  try {
    const res = await fetch(`/api/riot-api?endpoint=/lol/status/v4/platform-data&region=${region}`);
    if (!res.ok) {
      statusElement.textContent = "âš ï¸ Unable to check server status";
      statusElement.style.color = "#ffa500";
      return;
    }
    const data = await res.json();
    
    if (data.incidents && data.incidents.length > 0) {
      statusElement.textContent = `âš ï¸ Server Issues: ${data.incidents.length} incident(s)`;
      statusElement.style.color = "#ff0000";
    } else if (data.maintenances && data.maintenances.length > 0) {
      statusElement.textContent = `ðŸ”§ Maintenance: ${data.maintenances.length} scheduled`;
      statusElement.style.color = "#ffa500";
    } else {
      statusElement.textContent = `âœ… ${data.name} - All systems operational`;
      statusElement.style.color = "#0f0";
    }
  } catch (err) {
    console.error("Failed to check server status:", err);
    statusElement.textContent = "Status check unavailable";
    statusElement.style.color = "#888";
  }
}

async function fetchSummonerProfile(name, region = "NA1") {
  const note = document.getElementById("status-note");
  const saveBtn = document.getElementById("save-profile");
  saveBtn.disabled = true;
  note.textContent = "Loading summoner data...";
  const cleanName = name.trim().replace(/#/g, "").replace(/\s+/g, " ");

  try {
    // STEP 1: get summoner info by name
    const res = await fetch(`/api/riot-api?endpoint=/lol/summoner/v4/summoners/by-name/${encodeURIComponent(cleanName)}&region=${region}`);
    if (!res.ok) throw new Error(`Name not found`);
    const summoner = await res.json();

    if (!summoner.puuid) throw new Error("No PUUID returned");

    // STEP 2: get ranked info
    const rankedRes = await fetch(`/api/riot-api?endpoint=/lol/league/v4/entries/by-summoner/${summoner.id}&region=${region}`);
    const ranked = rankedRes.ok ? await rankedRes.json() : [];
    const solo = ranked.find(r => r.queueType === "RANKED_SOLO_5x5");

    // display
    document.getElementById("profile-icon").src =
      `https://ddragon.leagueoflegends.com/cdn/14.1.1/img/profileicon/${summoner.profileIconId}.png`;
    document.getElementById("summoner-name").textContent = summoner.name;
    document.getElementById("summoner-level").textContent = `Level ${summoner.summonerLevel}`;
    document.getElementById("summoner-rank").textContent = solo
      ? `${solo.tier} ${solo.rank} Â· ${solo.leaguePoints} LP`
      : "Unranked";

    currentSummoner = {
      name: summoner.name,
      id: summoner.id,
      puuid: summoner.puuid,
      level: summoner.summonerLevel,
      profileIconId: summoner.profileIconId,
      region,
      rank: solo || null
    };

    note.textContent = "âœ… Profile loaded â€” save or enter home.";
    saveBtn.disabled = false;
  } catch (err) {
    console.error(err);
    note.textContent = "âŒ Summoner not found or API error.";
    currentSummoner = null;
    saveBtn.disabled = true;
  }
}

document.getElementById("search-btn").addEventListener("click", () => {
  const name = document.getElementById("summoner-input").value.trim();
  const region = document.getElementById("region-select").value;
  if (name) fetchSummonerProfile(name, region);
});

document.getElementById("summoner-input").addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    const name = document.getElementById("summoner-input").value.trim();
    const region = document.getElementById("region-select").value;
    if (name) fetchSummonerProfile(name, region);
  }
});

document.getElementById("save-profile").addEventListener("click", () => {
  if (currentSummoner) {
    localStorage.setItem("selectedSummoner", JSON.stringify(currentSummoner));
    document.getElementById("status-note").textContent = "ðŸ’¾ Profile saved locally!";
  } else {
    document.getElementById("status-note").textContent = "âš ï¸ No profile loaded.";
  }
});

document.getElementById("goto-home").addEventListener("click", () => {
  const saved = localStorage.getItem("selectedSummoner");
  if (!saved && !currentSummoner) {
    const note = document.getElementById("status-note");
    note.textContent = "âš ï¸ Load a profile first.";
    return;
  }
  if (currentSummoner && !saved) {
    localStorage.setItem("selectedSummoner", JSON.stringify(currentSummoner));
  }
  window.location.href = "homeroom.html";
});

window.addEventListener("DOMContentLoaded", () => {
  const regionSelect = document.getElementById("region-select");
  checkServerStatus(regionSelect.value);
  
  const saved = localStorage.getItem("selectedSummoner");
  if (saved) {
    try {
      const summoner = JSON.parse(saved);
      currentSummoner = summoner;
      document.getElementById("profile-icon").src =
        `https://ddragon.leagueoflegends.com/cdn/14.1.1/img/profileicon/${summoner.profileIconId}.png`;
      document.getElementById("summoner-name").textContent = summoner.name;
      document.getElementById("summoner-level").textContent = `Level ${summoner.level}`;
      document.getElementById("summoner-rank").textContent = summoner.rank
        ? `${summoner.rank.tier} ${summoner.rank.rank} Â· ${summoner.rank.leaguePoints} LP`
        : "Unranked";
      document.getElementById("status-note").textContent = "ðŸ’¾ Previously saved profile loaded.";
      document.getElementById("save-profile").disabled = false;
      document.getElementById("region-select").value = summoner.region || "EUW1";
    } catch (err) {
      console.error("Failed to load saved summoner:", err);
    }
  }
});

document.getElementById("region-select").addEventListener("change", (e) => {
  checkServerStatus(e.target.value);
});
</script>
</body>
</html>
