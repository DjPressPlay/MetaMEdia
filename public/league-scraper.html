<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>League of Legends MetaDock ‚Äì Summoner Setup</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: radial-gradient(circle at center, #0a0a0a, #000);
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.selector-wrapper {
  border: 3px solid #00ffff;
  border-radius: 12px;
  background: rgba(10,10,10,0.9);
  box-shadow: 0 0 30px rgba(0,255,255,0.4);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 24px;
  width: 380px;
}

.selector-header {
  font-size: 22px;
  font-weight: bold;
  color: #00ffff;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 20px;
  text-shadow: 0 0 10px #00ffff;
}

.search-row {
  display: flex;
  gap: 10px;
  width: 100%;
  justify-content: center;
  margin-bottom: 20px;
}
.search-row input {
  flex: 1;
  background: #111;
  border: 1px solid #00ffff;
  border-radius: 6px;
  color: #fff;
  padding: 8px 12px;
  font-size: 14px;
}
.search-row button {
  background: #00ffff;
  color: #000;
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}
.search-row button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 10px #00ffff;
}
.search-row button:disabled {
  background: #333;
  color: #777;
  cursor: not-allowed;
}

.profile-display {
  width: 200px;
  height: 200px;
  border: 2px solid #00ffff;
  border-radius: 12px;
  background: #111 url("./METAMEDIA/lol.jpeg") center/cover no-repeat;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  margin-bottom: 12px;
}
.profile-display img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.summoner-name {
  font-size: 18px;
  margin-top: 10px;
  text-shadow: 0 0 8px #00ffff;
}
.summoner-level {
  font-size: 13px;
  color: #aaa;
  margin-top: 4px;
}
.rank-display {
  margin-top: 10px;
  font-size: 14px;
  color: #00ffff;
  text-shadow: 0 0 8px rgba(0,255,255,0.7);
}

.action-row {
  margin-top: 20px;
  display: flex;
  gap: 12px;
}
.action-row button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}
.save-btn { background: #00ffff; color: #000; }
.home-btn { background: #111; border: 1px solid #00ffff; color: #00ffff; }
.save-btn:hover, .home-btn:hover { transform: scale(1.05); }

.status {
  margin-top: 16px;
  font-size: 14px;
  text-align: center;
}
.loading { color: #ffd24d; }
.error { color: #ff6b6b; }
.success { color: #00ff99; }
</style>
</head>
<body>

<div class="selector-wrapper">
  <div class="selector-header">Summoner Setup</div>

  <div class="search-row">
    <input id="summoner" placeholder="Enter Summoner Name..." onkeypress="if(event.key==='Enter')runScrape()" disabled>
    <button id="searchBtn" onclick="runScrape()" disabled>Search</button>
  </div>

  <div class="profile-display">
    <img id="profile-icon" src="./METAMEDIA/lol.jpeg" alt="Profile Icon">
  </div>

  <div class="summoner-name" id="player-name">No Profile Loaded</div>
  <div class="summoner-level" id="player-level"></div>
  <div class="rank-display" id="player-rank"></div>

  <div class="action-row">
    <button class="save-btn" id="save-profile">Save Profile</button>
    <button class="home-btn" id="goto-home">Enter Home Room</button>
  </div>

  <div class="status" id="status"></div>
</div>

<script>
window.addEventListener("DOMContentLoaded", checkRegionStatus);

// üîπ Check region status via Netlify Function
async function checkRegionStatus() {
  const statusDiv = document.getElementById("status");
  const input = document.getElementById("summoner");
  const btn = document.getElementById("searchBtn");

  statusDiv.textContent = "Checking online status...";
  statusDiv.className = "status loading";

  try {
    const res = await fetch("/.netlify/functions/checkStatus");
    if (!res.ok) throw new Error("Unable to reach status endpoint");
    const data = await res.json();

    if (data.allOnline) {
      statusDiv.textContent = "‚úÖ All regions online.";
      statusDiv.className = "status success";
      input.disabled = false;
      btn.disabled = false;
    } else {
      statusDiv.textContent = `‚ö†Ô∏è Offline: ${data.offlineRegions.join(", ")}`;
      statusDiv.className = "status error";
    }
  } catch (err) {
    console.error("Status Check Error:", err);
    statusDiv.textContent = "‚ö†Ô∏è Could not reach Riot servers.";
    statusDiv.className = "status error";
  }
}

// üîπ Fetch Summoner Info
async function fetchProfile(name) {
  const url = `https://www.leagueofgraphs.com/summoner/na/${encodeURIComponent(name)}`;
  const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxied);
  if (!res.ok) throw new Error("Failed to load player page");
  const html = await res.text();
  if (!html.includes("<html")) throw new Error("Invalid HTML response");
  return html;
}

// üîπ Scrape + Render
async function runScrape() {
  const name = document.getElementById("summoner").value.trim();
  const status = document.getElementById("status");
  const profileIcon = document.getElementById("profile-icon");

  if (!name) {
    status.textContent = "Enter a summoner name first.";
    status.className = "status error";
    return;
  }

  status.textContent = "Verifying Riot API status...";
  status.className = "status loading";

  try {
    const statusRes = await fetch("/.netlify/functions/checkStatus");
    if (!statusRes.ok) throw new Error("Unable to verify Riot API status");
    const statusData = await statusRes.json();

    if (!statusData.allOnline) {
      status.textContent = `‚ö†Ô∏è Riot servers offline: ${statusData.offlineRegions.join(", ")}`;
      status.className = "status error";
      return;
    }

    status.textContent = "Fetching data...";
    const html = await fetchProfile(name);
    const doc = new DOMParser().parseFromString(html, "text/html");

    const level = doc.querySelector(".bannerSubtitle")?.textContent.replace("Level","").trim() || "Unknown";
    const rankTier = doc.querySelector(".leagueTier")?.textContent.trim() || "Unranked";

    document.getElementById("player-name").textContent = name;
    document.getElementById("player-level").textContent = `Level ${level}`;
    document.getElementById("player-rank").textContent = rankTier;

    profileIcon.src = "./METAMEDIA/lol.jpeg"; // Always local image

    status.textContent = "‚úÖ Profile loaded.";
    status.className = "status success";
  } catch (err) {
    console.error(err);
    status.textContent = "Error: " + err.message;
    status.className = "status error";
  }
}
</script>
</body>
</html>
